{% extends 'admin/base.html.twig' %}

{% block title %}Jobs{% endblock %}

{% block body %}
<div class="content-wrapper">
    <div class="row">
        <div class="col-12 grid-margin stretch-card">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h4 class="card-title">Upwork Jobs</h4>
                            <p class="text-muted mb-0">
                                <i class="icon-briefcase"></i>
                                Total: <strong>{{ pagination.total_items }}</strong> jobs found
                                {% if pagination.total_pages > 1 %}
                                    (Page {{ pagination.current_page }} of {{ pagination.total_pages }})
                                {% endif %}
                            </p>
                        </div>
                        <div class="d-flex align-items-center">
                            <form method="get" class="d-inline mr-3">
                                <div class="form-group mb-0">
                                    <label for="per_page" class="sr-only">Items per page</label>
                                    <select name="per_page" id="per_page" class="form-control form-control-sm" onchange="this.form.submit()">
                                        {% for option in allowedPerPage %}
                                            <option value="{{ option }}" {% if perPage == option %}selected{% endif %}>
                                                {{ option }} per page
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <input type="hidden" name="page" value="{{ pagination.current_page }}">
                            </form>
                            <form method="post" action="{{ path('app_jobs_fetch') }}" class="d-inline">
                                <button type="submit" class="btn btn-primary">
                                    <i class="icon-refresh"></i>
                                    Fetch New Jobs
                                </button>
                            </form>
                        </div>
                    </div>

                    {% for message in app.flashes('success') %}
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                    {% endfor %}

                    {% for message in app.flashes('error') %}
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                    {% endfor %}

                    {% for message in app.flashes('info') %}
                        <div class="alert alert-info alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                    {% endfor %}

                    {% if jobs is empty %}
                        <div class="text-center py-5">
                            <i class="icon-briefcase" style="font-size: 4rem; color: #ccc;"></i>
                            <h5 class="mt-3">No jobs found</h5>
                            <p class="text-muted">Click "Fetch New Jobs" to search for jobs based on your settings.</p>
                        </div>
                    {% else %}
                        <!-- Bulk Actions -->
                        <div class="mb-3">
                            <button type="button" class="btn btn-danger" id="bulkDeleteBtn" disabled>
                                <i class="icon-trash"></i>
                                Delete Selected (<span id="selectedCount">0</span>)
                            </button>
                        </div>

                        <form id="bulkDeleteForm" method="post" action="{{ path('app_jobs_bulk_delete') }}">
                            <!-- Hidden inputs will be added dynamically -->
                        </form>

                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th width="50">
                                            <input type="checkbox" id="selectAllCheckbox" title="Select All">
                                        </th>
                                        <th>Title</th>
                                        <th>Client</th>
                                        <th>Budget</th>
                                        <th>Country</th>
                                        <th>Posted</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for job in jobs %}
                                        <tr>
                                            <td>
                                                <input type="checkbox" class="job-checkbox" value="{{ job.id }}">
                                            </td>
                                            <td>
                                                <strong>{{ job.title }}</strong>
                                                {% if job.skills %}
                                                    <br><small class="text-muted">{{ job.skills }}</small>
                                                {% endif %}
                                            </td>
                                            <td>{{ job.client ?? 'Unknown' }}</td>
                                            <td>{{ job.budget ?? 'Not specified' }}</td>
                                            <td>{{ job.country ?? 'Unknown' }}</td>
                                            <td>{{ job.postedAt|date('M d, Y') }}</td>
                                            <td>
                                                <a href="{{ path('app_jobs_show', {'id': job.id}) }}" class="btn btn-sm btn-info">
                                                    <i class="icon-eye"></i>
                                                    View
                                                </a>
                                                <button type="button" class="btn btn-sm btn-danger delete-job-btn" data-job-id="{{ job.id }}" data-job-title="{{ job.title }}">
                                                    <i class="icon-trash"></i>
                                                    Delete
                                                </button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination Controls -->
                        {% if pagination.total_pages > 1 %}
                            <nav aria-label="Jobs pagination" class="mt-4">
                                <ul class="pagination justify-content-center">
                                    <!-- Previous Page -->
                                    {% if pagination.has_previous %}
                                        <li class="page-item">
                                            <a class="page-link" href="{{ path('app_jobs_index', {'page': pagination.previous_page, 'per_page': perPage}) }}">
                                                <i class="icon-arrow-left"></i> Previous
                                            </a>
                                        </li>
                                    {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link">
                                                <i class="icon-arrow-left"></i> Previous
                                            </span>
                                        </li>
                                    {% endif %}

                                    <!-- Page Numbers -->
                                    {% set startPage = max(1, pagination.current_page - 2) %}
                                    {% set endPage = min(pagination.total_pages, pagination.current_page + 2) %}
                                    
                                    {% if startPage > 1 %}
                                        <li class="page-item">
                                            <a class="page-link" href="{{ path('app_jobs_index', {'page': 1, 'per_page': perPage}) }}">1</a>
                                        </li>
                                        {% if startPage > 2 %}
                                            <li class="page-item disabled">
                                                <span class="page-link">...</span>
                                            </li>
                                        {% endif %}
                                    {% endif %}

                                    {% for pageNum in startPage..endPage %}
                                        <li class="page-item {% if pageNum == pagination.current_page %}active{% endif %}">
                                            {% if pageNum == pagination.current_page %}
                                                <span class="page-link">{{ pageNum }}</span>
                                            {% else %}
                                                <a class="page-link" href="{{ path('app_jobs_index', {'page': pageNum, 'per_page': perPage}) }}">{{ pageNum }}</a>
                                            {% endif %}
                                        </li>
                                    {% endfor %}

                                    {% if endPage < pagination.total_pages %}
                                        {% if endPage < pagination.total_pages - 1 %}
                                            <li class="page-item disabled">
                                                <span class="page-link">...</span>
                                            </li>
                                        {% endif %}
                                        <li class="page-item">
                                            <a class="page-link" href="{{ path('app_jobs_index', {'page': pagination.total_pages, 'per_page': perPage}) }}">{{ pagination.total_pages }}</a>
                                        </li>
                                    {% endif %}

                                    <!-- Next Page -->
                                    {% if pagination.has_next %}
                                        <li class="page-item">
                                            <a class="page-link" href="{{ path('app_jobs_index', {'page': pagination.next_page, 'per_page': perPage}) }}">
                                                Next <i class="icon-arrow-right"></i>
                                            </a>
                                        </li>
                                    {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link">
                                                Next <i class="icon-arrow-right"></i>
                                            </span>
                                        </li>
                                    {% endif %}
                                </ul>
                            </nav>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Individual Delete Confirmation Modal -->
<div class="modal fade" id="deleteJobModal" tabindex="-1" role="dialog" aria-labelledby="deleteJobModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteJobModalLabel">Confirm Job Deletion</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this job?</p>
                <p><strong id="jobTitleToDelete"></strong></p>
                <p class="text-danger"><i class="icon-alert-circle"></i> This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="icon-close"></i> Cancel
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteJob">
                    <i class="icon-trash"></i> Delete Job
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Delete Confirmation Modal -->
<div class="modal fade" id="bulkDeleteModal" tabindex="-1" role="dialog" aria-labelledby="bulkDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkDeleteModalLabel">Confirm Bulk Job Deletion</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong id="bulkDeleteCount"></strong> selected jobs?</p>
                <p class="text-danger"><i class="icon-alert-circle"></i> This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="icon-close"></i> Cancel
                </button>
                <button type="button" class="btn btn-danger" id="confirmBulkDelete">
                    <i class="icon-trash"></i> Delete Jobs
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const jobCheckboxes = document.querySelectorAll('.job-checkbox');
    const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const selectedCountSpan = document.getElementById('selectedCount');
    const deleteJobBtns = document.querySelectorAll('.delete-job-btn');
    const bulkDeleteForm = document.getElementById('bulkDeleteForm');
    const deleteJobModal = document.getElementById('deleteJobModal');
    const bulkDeleteModal = document.getElementById('bulkDeleteModal');

    // Select All functionality
    selectAllCheckbox.addEventListener('change', function() {
        jobCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateBulkDeleteButton();
    });

    // Individual checkbox change
    jobCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateBulkDeleteButton();
            updateSelectAllCheckbox();
        });
    });

    function updateBulkDeleteButton() {
        const checkedBoxes = document.querySelectorAll('.job-checkbox:checked');
        const count = checkedBoxes.length;
        
        selectedCountSpan.textContent = count;
        bulkDeleteBtn.disabled = count === 0;
    }

    function updateSelectAllCheckbox() {
        const totalCheckboxes = jobCheckboxes.length;
        const checkedCheckboxes = document.querySelectorAll('.job-checkbox:checked').length;
        
        if (checkedCheckboxes === 0) {
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = false;
        } else if (checkedCheckboxes === totalCheckboxes) {
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = true;
        } else {
            selectAllCheckbox.indeterminate = true;
        }
    }

    // Bulk delete functionality
    bulkDeleteBtn.addEventListener('click', function() {
        const checkedBoxes = document.querySelectorAll('.job-checkbox:checked');
        if (checkedBoxes.length === 0) {
            alert('Please select at least one job to delete.');
            return;
        }
        
        document.getElementById('bulkDeleteCount').textContent = checkedBoxes.length;
        $(bulkDeleteModal).modal('show');
    });

    document.getElementById('confirmBulkDelete').addEventListener('click', function() {
        const checkedBoxes = document.querySelectorAll('.job-checkbox:checked');
        const jobIds = Array.from(checkedBoxes).map(cb => cb.value);
        
        // Clear existing hidden inputs
        bulkDeleteForm.innerHTML = '';
        
        // Add each job ID as a separate hidden input
        jobIds.forEach(jobId => {
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'job_ids[]';
            hiddenInput.value = jobId;
            bulkDeleteForm.appendChild(hiddenInput);
        });
        
        // Submit the form
        bulkDeleteForm.submit();
    });

    // Individual delete functionality
    deleteJobBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const jobId = this.dataset.jobId;
            const jobTitle = this.dataset.jobTitle;
            
            document.getElementById('jobTitleToDelete').textContent = jobTitle;
            $(deleteJobModal).modal('show');
            
            // Store the job ID for the confirm button
            deleteJobModal.dataset.jobId = jobId;
        });
    });

    document.getElementById('confirmDeleteJob').addEventListener('click', function() {
        const jobId = deleteJobModal.dataset.jobId;
        
        // Create a form and submit it
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/jobs/${jobId}/delete`;
        document.body.appendChild(form);
        form.submit();
    });
});
</script>
{% endblock %}
